<script>
    // Global object to track the ping and countdown timers
    const pingTimers = {};
    const countdownTimers = {};

    // Load saved devices when the page loads
    window.onload = function() {
        loadCommands();
    };

    // Load saved commands
    function loadCommands() {
        fetch('/get-commands')
            .then(response => response.json())
            .then(commands => {
                commands.forEach(command => {
                    addCommandToUI(command.name, command.ip, command.mac);
                });
            })
            .catch(error => {
                console.error('Error loading commands:', error);
            });
    }

    // Add a command to the UI
    function addCommandToUI(name, ip, mac) {
        const commandDiv = document.createElement('div');
        commandDiv.classList.add('command-card');
        commandDiv.id = `command-${ip}`; // ID for deletion
        commandDiv.innerHTML = `
            <div style="display: flex; align-items: center;">
                <div>
                    <!-- Red delete button -->
                    <button onclick="deleteCommand('${ip}')" class="btn red delete-btn">-</button>
                </div>
                <div>
                    <!-- Device name and MAC address with IP -->
                    <span style="font-weight: bold;">${name}</span>
                    <span class="mac-address">${mac} (${ip})</span>
                </div>
            </div>
            <div>
                <!-- Online status dot and Wake-on-LAN button -->
                <span id="status-dot-${ip}" class="status-dot offline"></span>
                <a id="wake-btn-${ip}" class="btn waves-effect waves-light" onclick="executeCommand('${ip}', '${mac}')">Wake-on-LAN</a>
            </div>
        `;
        document.getElementById('command-list').appendChild(commandDiv);
    }

    // Execute Wake-on-LAN command and start pinging + countdown
    function executeCommand(ip, mac) {
        // Send the WoL command
        fetch('/execute-command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ip, mac }),
        })
        .then(response => response.json())
        .then(data => {
            M.toast({html: data.message});

            // Start pinging the device
            startPinging(ip);

            // Start countdown and set it on the button
            startCountdown(ip, 120);  // Countdown for 2 minutes (120 seconds)

            // After 2 minutes, stop pinging and set status to yellow
            setTimeout(() => {
                stopPinging(ip);
                setStatusYellow(ip);
                resetWakeButton(ip); // Reset the button after countdown
            }, 120000); // 2 minutes in milliseconds
        })
        .catch(error => {
            console.error('Error executing command:', error);
        });
    }

    // Start pinging the host
    function startPinging(ip) {
        if (pingTimers[ip]) {
            clearInterval(pingTimers[ip]); // Clear any existing ping interval
        }

        // Ping the device every 5 seconds for 2 minutes
        pingTimers[ip] = setInterval(() => {
            pingHost(ip);
        }, 5000);
    }

    // Stop pinging the host
    function stopPinging(ip) {
        if (pingTimers[ip]) {
            clearInterval(pingTimers[ip]);
            delete pingTimers[ip];
        }
    }

    // Ping a host and update UI
    function pingHost(ip) {
        fetch('/ping-host', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ip }),
        })
        .then(response => response.json())
        .then(data => {
            const statusDot = document.getElementById(`status-dot-${ip}`);
            if (data.message === 'Device is reachable') {
                statusDot.classList.remove('offline', 'yellow');
                statusDot.classList.add('online');
            } else {
                statusDot.classList.remove('online', 'yellow');
                statusDot.classList.add('offline');
            }
        })
        .catch(error => {
            console.error('Error pinging host:', error);
        });
    }

    // Start countdown timer on the Wake button
    function startCountdown(ip, duration) {
        const wakeButton = document.getElementById(`wake-btn-${ip}`);
        let remainingTime = duration; // Countdown starts from 120 seconds (2 minutes)

        // Update the button text every second
        countdownTimers[ip] = setInterval(() => {
            wakeButton.textContent = `Waking... (${remainingTime}s)`;
            remainingTime--;

            // Stop the countdown when it reaches 0
            if (remainingTime < 0) {
                clearInterval(countdownTimers[ip]);
            }
        }, 1000);
    }

    // Reset Wake button text to "Wake-on-LAN" after countdown ends
    function resetWakeButton(ip) {
        const wakeButton = document.getElementById(`wake-btn-${ip}`);
        wakeButton.textContent = 'Wake-on-LAN';
    }

    // Set status to yellow after 2 minutes
    function setStatusYellow(ip) {
        const statusDot = document.getElementById(`status-dot-${ip}`);
        if (statusDot) {
            statusDot.classList.remove('online', 'offline');
            statusDot.classList.add('yellow');
        }
    }

    // Delete a command
    function deleteCommand(ip) {
        fetch('/delete-command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ip }),
        })
        .then(response => response.json())
        .then(data => {
            M.toast({html: data.message});
            // Remove the device from the UI
            const commandList = document.getElementById('command-list');
            const commandDiv = document.getElementById(`command-${ip}`);
            if (commandDiv) {
                commandList.removeChild(commandDiv);
            }
        })
        .catch(error => {
            console.error('Error deleting command:', error);
        });
    }
</script>
